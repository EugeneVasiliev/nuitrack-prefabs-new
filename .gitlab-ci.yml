stages:
- build_package
- build_demo_apk
- build_demo_abb

build_unity_package:
  stage: "build_package"
  tags:
    - windows_x64
  script:
    - pip install git+http://gitlab-ci-token:%CI_JOB_TOKEN%@tox.3divi.ru/3divi-devops/3divi-ctl-client.git@windows_fix
    - call Scripts\3divi-ctl-win-wrapper.bat ../depth_scanner/arm32 artifact://3d/depth_scanner/ubuntu-14.04.5-android-arm32:Fittar_v0.35.1_v2.1
    - call Scripts\3divi-ctl-win-wrapper.bat ../depth_scanner/arm64 artifact://3d/depth_scanner/ubuntu-14.04.5-android-arm64:Fittar_v0.35.1_v2.1
    - copy /y "..\depth_scanner\arm64\depth_scanner\deployment\NuitrackSDK\Nuitrack\lib\android-arm64\*.so" "Assets/Plugins/Android/libs/arm64-v8a"
    - copy /y "..\depth_scanner\arm32\depth_scanner\deployment\NuitrackSDK\Nuitrack\lib\android\*.so" "Assets/Plugins/Android/libs/armeabi-v7a"
    - rmdir /s /q "..\depth_scanner"
    - '"C:\Program Files\Unity2018.3\Editor\Unity.exe" -batchmode -quit -projectPath %cd% -exportPackage "Assets/NuitrackSDK" "Assets/Plugins" %cd%/NuitrackSDK.unitypackage'
  artifacts:
    paths:
      - NuitrackSDK.unitypackage
    expire_in: 14d

build_apk:
  stage: "build_demo_apk"
  tags:
    - windows_x64
  script:
    - '"C:\Program Files\Unity2018.3\Editor\Unity.exe" -batchmode -quit -projectPath %cd% -logFile %cd%/build_log.txt -executeMethod BuildMyGame.BuildApk %cd%/NuitrackDemo.apk'
  artifacts:
    paths:
      - NuitrackDemo.apk
    expire_in: 14d

build_aab:
  stage: "build_demo_abb"
  tags:
    - windows_x64
  script:
    - '"C:\Program Files\Unity2018.3\Editor\Unity.exe" -batchmode -quit -projectPath %cd% -logFile %cd%/build_log.txt -executeMethod BuildMyGame.BuildAab %cd%/NuitrackDemo.aab'
  artifacts:
    paths:
      - NuitrackDemo.aab
    expire_in: 14d